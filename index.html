<script type="module">
import { deriveKey, encryptAES, decryptAES } from "./crypto.js";

let USER="", ROOM="", roomRef;
let ENC_KEY = null;
const encSel=new Set(), decSel=new Set();

function enterRoom(){
  USER=username.value.trim();
  ROOM=room.value.trim();
  if(!USER||!ROOM) return alert("Bilgiler eksik");

  userName.textContent=USER;
  roomName.textContent=ROOM;
  login.classList.add("hidden");
  chat.classList.remove("hidden");

  roomRef = fbRef(db,"rooms/"+ROOM);

  fbOnAdd(roomRef, async snap=>{
    const d=snap.val();
    const div=document.createElement("div");
    div.className="msg "+(d.user===USER?"me":"other");

    try{
      const key = await deriveKey(secret.value, d.layers);
      const txt = await decryptAES(key, d.cipher, d.iv);
      div.innerHTML=`<b>${d.user}</b><br>${txt}`;
    }catch{
      div.innerHTML=`<b>${d.user}</b><br>⚠️ Çözülemedi`;
    }

    log.appendChild(div);
    log.scrollTop=log.scrollHeight;
  });
}

async function encrypt(){
  if(!message.value) return;

  const key = await deriveKey(secret.value, encSel);
  const enc = await encryptAES(key, message.value);

  fbPush(roomRef,{
    user: USER,
    cipher: enc.cipher,
    iv: enc.iv,
    layers: [...encSel],
    time: Date.now()
  });

  message.value="";
}

async function decrypt(){
  try{
    const key = await deriveKey(secret.value, decSel);
    const txt = await decryptAES(key, cipher.value, ivInput.value);
    result.textContent="Çözüm: "+txt;
  }catch{
    result.textContent="⚠️ Anahtar / katman yanlış";
  }
}
</script>
